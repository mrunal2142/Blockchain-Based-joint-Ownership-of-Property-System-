var O=()=>typeof window<"u"&&window.localStorage.getItem("IS_PAPER_DEV")==="true",v=()=>!!(typeof window<"u"&&window.location.origin.includes("zeet.app")),G=()=>typeof window<"u"&&window.location.origin.includes("paper.xyz"),b=()=>{var a;return O()?"http://localhost:3000":v()?(a=process==null?void 0:process.env)!=null&&a.ZEET_DEPLOYMENT_URL?`https://${process.env.ZEET_DEPLOYMENT_URL}`:typeof window<"u"?window.location.origin:"https://withpaper.com":G()?window.location.origin:"https://withpaper.com"},D=b(),u="/sdk/2022-08-12/embedded-wallet",Z=`${u}/login-with-otp`,q=`${u}/create-new-wallet-ui`,V=`${u}/set-up-new-device-ui`,x="walletToken",I=a=>`${x}-${a}`,P="a",g=a=>`${P}-${a}`,W={Ethereum:"https://rpc.ankr.com/eth",Goerli:"https://eth-goerli.g.alchemy.com/v2/demo",Mumbai:"https://rpc-mumbai.maticvigil.com",Polygon:"https://rpc-mainnet.maticvigil.com"};var M=(i=>(i.PAPER_EMAIL_OTP="PaperEmailOTP",i.GOOGLE="Google",i.AUTH0="Auth0",i.CUSTOM_JWT="CustomJWT",i))(M||{});var S=(t=>(t.LOGGED_OUT="Logged Out",t.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",t))(S||{}),L=(i=>(i.LOGGED_OUT="Logged Out",i.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",i.LOGGED_IN_NEW_DEVICE="Logged In, New Device",i.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",i))(L||{});var C=new Map,l=class{constructor({clientId:e}){this.isSupported=typeof window<"u"&&!!window.localStorage,this.clientId=e}async getItem(e){return this.isSupported?window.localStorage.getItem(e):C.get(e)??null}async setItem(e,t){if(this.isSupported)return window.localStorage.setItem(e,t);C.set(e,t)}async removeItem(e){let t=await this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1}async saveAuthCookie(e){this.setItem(I(this.clientId),e)}async getAuthCookie(){return this.getItem(I(this.clientId))}async removeAuthCookie(){return this.removeItem(I(this.clientId))}async saveDeviceShare(e){this.setItem(g(this.clientId),e)}async getDeviceShare(){return this.getItem(g(this.clientId))}async removeDeviceShare(){return this.removeItem(g(this.clientId))}};var U={top:"0px",left:"0px",right:"0px",bottom:"0px"},N=()=>({main:{...U,position:"fixed",zIndex:"1000",display:"flex",alignItems:"center",justifyContent:"center"},overlay:{...U,position:"absolute",backgroundColor:"rgba(0, 0, 0, 0.5)"},body:{boxShadow:"0px 10px 20px rgba(0, 0, 0, 0.25)",backgroundColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#2F2F2F":"white",borderRadius:"12px",padding:"16px",position:"relative",maxWidth:"600px",width:"100%",animation:"pew-modal-slideIn 0.2s forwards",height:"375px",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column",alignItems:"end"},iframe:{height:"100%",width:"100%",border:"none",backgroundColor:"transparent",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"}});function T(a){return new Promise(e=>{setTimeout(e,a*1e3)})}var w=new Map,y=class{constructor({link:e,iframeId:t,container:r=document.body,iframeStyles:i,onIframeInitialize:o}){this.POLLING_INTERVAL_SECONDS=1.4;this.POST_LOAD_BUFFER_SECONDS=1;let s=document.getElementById(t);if(!s||s.src!=e){if(!s){s=document.createElement("iframe");let n={...N().iframe,...i};Object.assign(s.style,n),s.setAttribute("id",t),r.appendChild(s)}s.src=e,s.onload=this.onIframeLoadHandler(s,this.POST_LOAD_BUFFER_SECONDS,o)}this.iframe=s}async onIframeLoadedInitVariables(){return{}}onIframeLoadHandler(e,t,r){return async()=>{await new Promise(async(o,s)=>{var h;let n=new MessageChannel;n.port1.onmessage=d=>{let{data:_}=d;return n.port1.close(),_.success?(w.set(e.src,!0),r&&r(),o(!0)):s(_.error)},await T(t);let m="initIframe";(h=e==null?void 0:e.contentWindow)==null||h.postMessage({eventType:m,data:await this.onIframeLoadedInitVariables()},"*",[n.port2])})}}async call({procedureName:e,params:t,showIframe:r=!1}){return new Promise(async(o,s)=>{var m;for(;!w.get(this.iframe.src);)await T(this.POLLING_INTERVAL_SECONDS);r&&(this.iframe.style.display="block",await T(.005));let n=new MessageChannel;n.port1.onmessage=async h=>{let{data:d}=h;return n.port1.close(),r&&(await T(.1),this.iframe.style.display="none"),d.success?o(d.data):s(d.error)},(m=this.iframe.contentWindow)==null||m.postMessage({eventType:e,data:t},"*",[n.port2])})}destroy(){w.delete(this.iframe.src)}};var E=class extends y{constructor({clientId:t,customizationOptions:r}){super({iframeId:Q,link:k({clientId:t,path:u,queryParams:r}).href,container:document.body});this.clientId=t}async onIframeLoadedInitVariables(){let t=new l({clientId:this.clientId});return{authCookie:await t.getAuthCookie(),deviceShareStored:await t.getDeviceShare(),clientId:this.clientId}}};function k({clientId:a,path:e,queryParams:t}){let r=new URL(e,D);if(r.searchParams.set("clientId",a),t)for(let i of Object.keys(t))r.searchParams.set(i,t[i].toString());return r}var Q="paper-embedded-wallet-iframe";var A=class{constructor({clientId:e,querier:t,onAuthSuccess:r}){this.clientId=e,this.AuthQuerier=t,this.localStorage=new l({clientId:e}),this.onAuthSuccess=r}async postLogin({storedToken:e}){return e.storeCookieString&&(this.localStorage.saveAuthCookie(e.cookieString),await this.AuthQuerier.call({procedureName:"saveAuthCookie",params:{authCookie:e.cookieString}})),await this.onAuthSuccess(e.authDetails)}async loginWithJwtAuth({token:e,authProvider:t}){let r=await this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:e,authProvider:t}});return this.postLogin(r)}async loginWithPaperModal(){let e=await this.AuthQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0});return this.postLogin(e)}async loginWithPaperEmailOtp({email:e}){let t=await this.AuthQuerier.call({procedureName:"loginWithPaperModal",params:{email:e},showIframe:!0});return this.postLogin(t)}async logout(){let{success:e}=await this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=await this.localStorage.removeAuthCookie(),r=await this.localStorage.removeDeviceShare();return{success:e||t||r}}};import{getDefaultProvider as F}from"@ethersproject/providers";var c=class{constructor({chain:e,clientId:t,querier:r}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=r}async callContract({contractAddress:e,methodArgs:t,methodInterface:r}){return await this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:e,method:{args:t,stub:r}}})}};import{Signer as H}from"@ethersproject/abstract-signer";import{defineReadOnly as z}from"@ethersproject/properties";var p=class extends H{constructor({provider:t,clientId:r,querier:i}){super();this.DEFAULT_ETHEREUM_CHAIN_ID=1;this.clientId=r,this.querier=i,z(this,"provider",t)}async getAddress(){let{address:t}=await this.querier.call({procedureName:"getAddress",params:void 0});return t}async signMessage(t){var i,o;let{signedMessage:r}=await this.querier.call({procedureName:"signMessage",params:{message:t,chainId:((o=await((i=this.provider)==null?void 0:i.getNetwork()))==null?void 0:o.chainId)??this.DEFAULT_ETHEREUM_CHAIN_ID}});return r}async signTransaction(t){var i,o;let{signedTransaction:r}=await this.querier.call({procedureName:"signTransaction",params:{transaction:t,chainId:((o=await((i=this.provider)==null?void 0:i.getNetwork()))==null?void 0:o.chainId)??this.DEFAULT_ETHEREUM_CHAIN_ID}});return r}connect(t){return new p({clientId:this.clientId,provider:t,querier:this.querier})}};var f=class{constructor({clientId:e,chain:t,querier:r}){this.clientId=e,this.chain=t,this.walletManagerQuerier=r,this.gasless=new c({chain:t,clientId:e,querier:r}),this.localStorage=new l({clientId:e})}async postSetUpWallet({deviceShareStored:e,walletAddress:t}){return this.localStorage.saveAuthCookie(e),await this.walletManagerQuerier.call({procedureName:"saveDeviceShare",params:{deviceShareStored:e}}),{walletAddress:t}}async createWallet(e){let t;return e.showUi?t=await this.walletManagerQuerier.call({procedureName:"createWalletUi",params:void 0,showIframe:!0}):t=await this.walletManagerQuerier.call({procedureName:"createWallet",params:void 0}),await this.postSetUpWallet(t),{walletAddress:t.walletAddress,initialUserStatus:"Logged In, Wallet Uninitialized"}}async setUpNewDevice(e){let t;return e.showUi?t=await this.walletManagerQuerier.call({procedureName:"setUpNewDeviceUi",params:void 0,showIframe:!0}):t=await this.walletManagerQuerier.call({procedureName:"setUpNewDevice",params:void 0}),await this.postSetUpWallet(t),{walletAddress:t.walletAddress,initialUserStatus:"Logged In, New Device"}}async getUserWalletStatus(){let e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:{...e.user,wallet:this}}:e}async initializeWallet(){let{status:e,user:t}=await this.getUserWalletStatus();switch(e){case"Logged In, New Device":return this.setUpNewDevice({showUi:!1});case"Logged In, Wallet Uninitialized":return this.createWallet({showUi:!1});case"Logged Out":return;case"Logged In, Wallet Initialized":return{initialUserStatus:"Logged In, Wallet Initialized",walletAddress:t.walletAddress}}}async setChain({chain:e}){this.chain=e,this.gasless=new c({chain:e,clientId:this.clientId,querier:this.walletManagerQuerier})}async getEthersJsSigner(e){return new p({clientId:this.clientId,provider:F((e==null?void 0:e.rpcEndpoint)??W[this.chain]),querier:this.walletManagerQuerier})}async getAddress(){return(await this.getEthersJsSigner()).getAddress()}};var R=class{constructor({clientId:e,chain:t,styles:r}){this.clientId=e,this.querier=new E({clientId:e,customizationOptions:r}),this.wallet=new f({clientId:e,chain:t,querier:this.querier}),this.auth=new A({clientId:e,querier:this.querier,onAuthSuccess:async i=>(await this.wallet.initializeWallet(),{user:{status:"Logged In, Wallet Initialized",authDetails:i,wallet:this.wallet,walletAddress:await(await this.wallet.getEthersJsSigner()).getAddress()}})})}async getUser(){let e=await this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return console.error("BAD STATE: If you see this repeatedly, please reach out to us on discord and let us know!"),await this.wallet.initializeWallet(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return{status:"Logged In, Wallet Initialized",...e.user}}}};export{I as AUTH_TOKEN_LOCAL_STORAGE_NAME,x as AUTH_TOKEN_LOCAL_STORAGE_PREFIX,M as AuthProvider,W as ChainToPublicRpc,g as DEVICE_SHARE_LOCAL_STORAGE_NAME,P as DEVICE_SHARE_LOCAL_STORAGE_PREFIX,q as EMBEDDED_WALLET_CREATE_WALLET_UI_PATH,Z as EMBEDDED_WALLET_OTP_PATH,u as EMBEDDED_WALLET_PATH,V as EMBEDDED_WALLET_SET_UP_NEW_DEVICE_UI_PATH,D as PAPER_APP_URL,R as PaperEmbeddedWalletSdk,S as UserStatus,L as UserWalletStatus,b as getPaperOriginUrl};
